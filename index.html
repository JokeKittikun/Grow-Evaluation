<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="icon" href="logo.png" type="image/x-icon">

    <!-- Google Font -->
    <!-- <link rel="preconnect" href="https://fonts.googleapis.com" /> -->
    <!-- <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /> -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet" />


    <title>Evaluation - HIM Chiang Mai</title>

    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: 0;
            /* overflow: auto; */
            font-family: "Inter", "Noto Sans Thai";
            /* white-space: nowrap; */
            line-height: 2;
        }

        body {
            /* padding: 20px; */
            background: #f3f3f3;
        }
        .link {
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border: 1px solid rgb(221, 221, 221);
            border-radius: 100%;
            padding: 10px;
            background-color: rgb(235, 235, 235);
        }
        .link:hover {
            background-color: rgb(195, 221, 193);
        }
        .img-sheet {
            width: 50px;
            height: 50px;
            text-align: center;
        }
        .area {
            /* display: flex; */
            /* flex-wrap: wrap; */
        }
        .flex-1 {
            flex: 1;
            /* min-width: 600px */
        }
        .d-flex {
            display: flex;
            justify-content: space-between;
            align-content: center;
            flex-wrap: wrap;
            grid-gap: 30px;
        }
        .card {
            border: 0px solid black;
            /* padding: 20px; */
            border-radius: 20px;
            margin: 30px;
            background: rgb(255, 255, 255);
            box-shadow: rgba(0, 0, 0, 0.1) 0px 1px 3px 0px, rgba(0, 0, 0, 0.06) 0px 1px 2px 0px;
        }
        .center {
            text-align: center;
        }
        .total {
            font-size: 100px;
            line-height: normal;
            overflow: hidden;
            padding: 20px 0;
        }
        h1 {
            font-size: 54px;
            line-height: 1;
            /* padding-top: 24px; */
            margin: 30px;
            margin-top: 8px;
            margin-bottom: 0;
            /* color: white */
        }
        h2 {
            padding-top: 24px;
            font-size: 40px;
            line-height: 1;
        }
        .m-0 {
            margin: 0;
        }
        .m-30 {
            margin: 30px;
        }
        .w-100 {
            width: 100%
        }
        .w-50 {
            width: 50%
        }
        .mw-1 {
            min-width: 320px;
        }
        #church {
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: 10px;
        }
        label {
            font-size: 24px;
            font-weight: bold;
        }
        .church {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #update {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            color: #696969;
        }
        h3 {
            font-size: 32px;
            line-height: normal;
        }
        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
        }
        .sub-header {
            font-size: 24px
        }
        .red {
            color: red;
        }
        .h2 {
            padding: 0;
            line-height: 1;
            font-size: 72px;
            color: green;
        }
        .gray {
            color: rgb(36, 36, 36)
        }
    </style>

</head>

<body>




    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" crossorigin="anonymous"></script>



    <a class="link" title="ดูแหล่งที่มาของข้อมูล" target="_blank" href="https://docs.google.com/spreadsheets/d/1JnQR3T-7sxISbH1bkrZUrM1-ROuNWku0x4Fv2dUrKoE/edit?usp=sharing"><img class="img-sheet" src="https://upload.wikimedia.org/wikipedia/commons/3/30/Google_Sheets_logo_%282014-2020%29.svg"/></a>

    <div id="map">
        <div class="loading">
            Loading data from Google Spreadsheets...
        </div>
    </div>
    
    <div class="area">
        <div class="logo">
            <img src="logo.png" width="80" alt="">
        </div>
        <h1 class="center">สรุปผลการประเมินโครงการ</h1>
        <h2 class="center h2">Grow</h2>
        <h3 class="center gray">(คริสตจักรฮิมเชียงใหม่)</h3>
        <span class="center" id="update"></span>
        
        <!-- <div class="card flex-1"> -->
            <div class="church">
                <label for="church" class="">เลือกคริสตจักร</label>
                <select id="church"></select>
            </div>
        <!-- </div> -->
        
        <div class="d-flex m-30">
            <div class="card flex-1 m-0 w-50 mw-1"> 
                <h2 class="center">จำนวนผู้กรอกแบบสอบถาม</h2>
                <h3 class="center total" id="total"></h3>
            </div>
            <div class="card flex-1 m-0 w-50 mw-1">
                <h2 class="center">จำแนกตามเพศ</h2>
                <div class="item chart2" style="height:250px">2</div>
            </div>
        </div>

        <div class="card flex-1">
            <h2 class="center">จำแนกตามคริสตจักร</h2>
            <div class="item chart1" style="height:300px">1</div>
        </div>

        <div class="d-flex m-30">
            <div class="card flex-1 m-0 w-50 mw-1"> 
                <h2 class="center">จำแนกตามช่วงอายุ</h2>
                <div class="item chart5" style="height:250px">5</div>
            </div>
            <div class="card flex-1 m-0 w-50 mw-1">
                <h2 class="center">จำแนกตามสถานะภาพ</h2>
                <div class="item chart6" style="height:250px">6</div>
            </div>
        </div>


        <div class="card flex-1">
            <h2 class="center">ตัวชี้วัดด้านการตระหนัก</h2>
            <h3 class="center red sub-header">*ประเมินจากผู้ที่ให้คะแนน<u>เห็นด้วยมากที่สุด</u></h3>
            <div class="item chart3" style="height:600px">3</div>
        </div>
        <div class="card flex-1">
            <h2 class="center">ตัวชี้วัดด้านพฤติกรรม</h2>
            <div class="item chart4" style="height:600px">4</div>
        </div>
    </div>
    


        <script>
            
                // document.addEventListener('DOMContentLoaded', function () {
                //     if ($("#church").val() == "All") {
                //         setInterval(function () {
                //             startLiveUpdate();
                //         }, 5 * 1000);
                //      }
                // });

            const bgColor = [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(0, 184, 148,0.6)',
                'rgba(232, 67, 147,0.6)',
                'rgba(214, 48, 49,0.6)',
                'rgba(253, 203, 110,0.6)',
                'rgba(99, 110, 114, 0.6)',
                'rgba(225, 112, 85,0.6)'
            ];
            const bdColor = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(0, 184, 148,1)',
                'rgba(232, 67, 147,1)',
                'rgba(214, 48, 49,1)',
                'rgba(253, 203, 110,1)',
                'rgba(99, 110, 114,1)',
                'rgba(225, 112, 85,1)'
            ];

            Chart.defaults.font.family = "Inter, Noto Sans Thai";
            Chart.defaults.font.size = 20;
            Chart.defaults.color = "black";

            $(".area").hide();
            startLiveUpdate();

            function startLiveUpdate () {
                
                
                const url = "https://docs.google.com/spreadsheets/d/1JnQR3T-7sxISbH1bkrZUrM1-ROuNWku0x4Fv2dUrKoE/gviz/tq?";

                var church = $("#church").val()||"All";
                fetch(url)
                    .then(res => res.text())
                    .then(data => {
                        const temp = data.substr(47).slice(0, -2);
                        const json = JSON.parse(temp);
                        const json_data = json.table.rows;
                        const json_key = json.table.cols;
                        const result = [];
                        var total = 0;
                        var countFilter = 0;
                        var churchList = [];
                        for (var i in json_data) {
                            const data = [];
                            churchVal = json_data[i].c[5];
                            if (churchVal == null) {
                                churchVal = json_data[i].c[10].v;
                            } else {
                                churchVal = json_data[i].c[5].v;    
                            }
                            churchList.push(churchVal);
                            
                            
                            if ((church == churchVal)) {
                                
                                var numData = Object.keys(json_data[i].c).length;
                                for (var j=0; j<numData; j++) {
                                    if (json_data[i].c[j] !== null) {
                                        data.push(json_data[i].c[j].v);
                                    }
                                }
                                countFilter = countFilter + 1;
                                total = countFilter
                                result.push(data);
                            } else if (church == "All") {
                                var numData = Object.keys(json_data[i].c).length;
                                for (var j=0; j<numData; j++) {
                                    if (json_data[i].c[j] !== null) {
                                        data.push(json_data[i].c[j].v);
                                    }
                                }
                                total = Object.keys(json_data).length;
                                result.push(data);
                            }
                        }
                                churchListFinal = [...new Set(churchList)].sort();
                                var opt = "<option value='All' selected>ทั้งหมด</option>";
                                for (var i in churchListFinal){
                                    $sel = "";
                                    if (church == churchListFinal[i]) {
                                        $sel = "selected";
                                    }
                                    opt += "<option value='" +churchListFinal[i]+ "' "+$sel+">"+churchListFinal[i]+"</option>";
                                }
                                $("#church").html(opt);
                                console.log("Church = " + church + " | Total = " + total);
                        
                                $("#total").html(total);

                                var question = [
                                    "ประทับเวลา",
                                    "เพศ",
                                    "อายุ",
                                    "สถานภาพ",
                                    "ภาคพันธกิจ",
                                    "คริสตจักร",
                                    "ท่านสามัคคีธรรมร่วมกับพระเจ้าและพี่น้องอยู่เสมอ",
                                    "ท่านจัดเวลาในการอธิษฐานทั้งส่วนตัว และส่วนรวมเป็นประจำ",
                                    "ท่านจัดเวลาในการอดอาหารอธิษฐานอย่างเจาะจงและชัดเจน",
                                    "ท่านจัดเวลาในการศึกษาพระวจนะ และนำพระวจนะมาใช้ในการดำเนินชีวิตอยู่เสมอ",
                                    "ท่านเรียนรู้ที่จะให้อภัยคนที่ทำผิดต่อท่าน เช่นเดียวกับที่พระคริสต์ทรงให้อภัยเรา",
                                    "ท่านใช้เวลาในการอธิษฐาน ศึกษาพระคัมภีร์ และนมัสการอย่างสม่ำเสมอ",
                                    "ท่านอุทิศตนเพื่อรับใช้โดยไม่หวังผลตอบแทน หรือได้รับคำชมจากผู้อื่น", 
                                    "ท่านมีความเชื่อจะวางใจในพระเจ้าและอดทนในสถานการณ์ที่ยากลำบาก",
                                    "ท่านมีความกล้าหาญและความรักในการแบ่งปันข่าวประเสริฐ",
                                    "ท่านพร้อมตัดสินใจตามพระคัมภีร์ แม้จะมีอุปสรรค",
                                    "ท่านพร้อมรับภาระช่วยเหลือพี่น้อง ด้วยความตั้งใจที่ถูกต้องและเป้าหมายที่ดีหรือไม่?",
                                    "ในเดือนเมษายน ท่านได้เข้าร่วมกลุ่มสามัคคีธรรมในทุกสัปดาห์",
                                    "ท่านได้เข้าร่วมอธิษฐานเช้าเป็นประจำทุก ๆ สัปดาห์",
                                    "ท่านตั้งใจในการอดอาหารอธิษฐาน 1 ครั้งต่อสัปดาห์",
                                    "ท่านได้เข้าชั้นเรียน พวอ. เป็นประจำ",
                                    "ท่านได้ตัดสินใจให้อภัยกับคนที่ทำผิดต่อท่าน",
                                    "ท่านเฝ้าเดี่ยวด้วยความตั้งใจอย่างน้อย 5 วันต่อสัปดาห์",
                                    "ท่านได้มาทำความสะอาดคริสตจักรอย่างน้อย 2 ครั้งต่อเดือน",
                                    "ท่านได้ยืนหยัดเพื่อรักษาชีวิตฝ่ายวิญญาณ(มโนธรรม) แม้จะต้องเผชิญกับมุมมองแง่ลบของผู้อื่น",
                                    "ท่านได้จัดเวลาออกไปประกาศข่าวประเสริฐอย่างน้อย 1 ครั้งต่อเดือน",
                                    "ในเดือนที่ผ่านมาท่านได้ถวายสิบลดด้วยใจยินดี",
                                    "ท่านตัดสินช่วยเหลือพี่น้องทันที เมื่อเห็นพี่น้องได้รับความเดือดร้อน",
                                    "ท่านได้วางแผนการใช้เวลากับลูกแกะเป็นประจำอย่างน้อย 1 วันต่อสัปดาห์",
                                ];





                               
                                // ============ PART 2 ============
                                var qList = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];

                                var qValList = [];
                                var yValList = [];

                                for (var q in qList) {
                                    var qVal = [];
                                    var feature = [];

                                    for (var i in result) {
                                        feature.push(result[i][qList[q]]);
                                    }  
                                    qVal.push(question[qList[q]]);

                                    var count = {};
                                    feature.forEach(function(i) { count[i] = (count[i]||0) + 1;});
                                    
                                    
                                    var xVal = [];
                                    var yVal = [];
                                    
                                    for (var i in Object.keys(count)) {
                                        if (Object.keys(count)[i] == "เห็นด้วยอย่างยิ่ง") {
                                            xVal.push(Object.keys(count)[i]);
                                            yVals = (count[Object.keys(count)[i]] / total * 100);
                                            if ((yVals == 0) || (yVals == 100) || (yVals % 1 == 0)) {
                                                yValue = (yVals).toFixed(0);
                                            } else {
                                                yValue = (yVals).toFixed(1);
                                            }
                                            yVal.push(yValue);
                                        }
                                    }
                                    qValList.push(qVal[0]);
                                    yValList.push(yVal[0]);
                                }



                                // ============ PART 3 ============
                                var qList3 = [17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28];

                                var qValList3 = [];
                                var yValList3 = [];

                                for (var q in qList3) {
                                    var qVal3 = [];
                                    var feature3 = [];

                                    for (var i in result) {
                                        feature3.push(result[i][qList3[q]]);
                                    }  
                                    qVal3.push(question[qList3[q]]);

                                    var count3 = {};
                                    feature3.forEach(function(i) { count3[i] = (count3[i]||0) + 1;});
                                    
                                    
                                    var xVal3 = [];
                                    var yVal3 = [];
                                    
                                    for (var i in Object.keys(count3)) {
                                        if (Object.keys(count3)[i] == "ใช่") {
                                            xVal3.push(Object.keys(count3)[i]);
                                            yVals3 = (count3[Object.keys(count3)[i]] / total * 100);
                                            if ((yVals3 == 0) || (yVals3 == 100) || (yVals3 % 1 == 0)) {
                                                yValue3 = (yVals3).toFixed(0);
                                            } else {
                                                yValue3 = (yVals3).toFixed(1);
                                            }
                                            yVal3.push(yValue3);
                                        }
                                    }
                                    qValList3.push(qVal3[0]);
                                    yValList3.push(yVal3[0]);
                                }






                            // ============ PART 1 ============

                            // ------------ Chart 1 -----------
                            var variable1 = 5;
                            feature_chart1 = [];
                            for (var i in result) {
                                if (result[i][variable1] == null ) {
                                    churchV = result[i][10];
                                } else {
                                    churchV = result[i][variable1];
                                }
                                feature_chart1.push(churchV);
                            }   

                            count_chart1 = {};
                            feature_chart1.forEach(function(i) { count_chart1[i] = (count_chart1[i]||0) + 1;});

                            
                            xVal_chart1 = [];
                            yVal_chart1 = [];
                            for (var i in Object.keys(count_chart1)) {

                                if (variable1 == 5) {
                                    xVals = $.trim(Object.keys(count_chart1)[i].split(':')[1]);
                                } else {
                                    xVals = Object.keys(count_chart1)[i];
                                }
                                // $.trim(result[1][5].split(':')[1])

                                xVal_chart1.push(xVals);
                                yVal_chart1.push(count_chart1[Object.keys(count_chart1)[i]]);
                            }


                            // ------------ Chart 2 -----------
                            var variable2 = 1;
                            feature_chart2 = [];
                            for (var i in result) {
                                feature_chart2.push(result[i][variable2]);
                            }
                            count_chart2 = {};
                            feature_chart2.forEach(function(i) { count_chart2[i] = (count_chart2[i]||0) + 1;});

                            xVal_chart2 = [];
                            yVal_chart2 = [];
                            for (var i in Object.keys(count_chart2)) {

                                xVals = Object.keys(count_chart2)[i];
                                xVal_chart2.push(xVals);
                                yVal_chart2.push(count_chart2[Object.keys(count_chart2)[i]]);
                            }

                            // ------------ Chart 5 -----------
                            var variable5 = 2;
                            feature_chart5 = [];
                            for (var i in result) {
                                feature_chart5.push(result[i][variable5]);
                            }
                            count_chart5 = {};
                            feature_chart5.forEach(function(i) { count_chart5[i] = (count_chart5[i]||0) + 1;});

                            xVal_chart5 = [];
                            yVal_chart5 = [];
                            for (var i in Object.keys(count_chart5)) {

                                xVals5 = Object.keys(count_chart5)[i];
                                xVal_chart5.push(xVals5);
                                yVal_chart5.push(count_chart5[Object.keys(count_chart5)[i]]);
                            }

                            // ------------ Chart 6 -----------
                            var variable6 = 3;
                            feature_chart6 = [];
                            for (var i in result) {
                                feature_chart6.push(result[i][variable6]);
                            }
                            count_chart6 = {};
                            feature_chart6.forEach(function(i) { count_chart6[i] = (count_chart6[i]||0) + 1;});

                            xVal_chart6 = [];
                            yVal_chart6 = [];
                            for (var i in Object.keys(count_chart6)) {

                                xVals6 = Object.keys(count_chart6)[i];
                                xVal_chart6.push(xVals6);
                                yVal_chart6.push(count_chart6[Object.keys(count_chart6)[i]]);
                            }

                            createChart("chart1", xVal_chart1, yVal_chart1, "bar", "x", false, "500", "จำนวนผู้กรอกแบบสอบถาม จำแนกตามคริสตจักร", true, false);
                            createChart("chart2", xVal_chart2, yVal_chart2, "pie", "x", true, "500", "", false, false);
                            createChart("chart3", qValList, yValList, "bar", "y", false, "500", "ตัวชี้วัด ด้าน ... ", true, true);
                            createChart("chart4", qValList3, yValList3, "bar", "y", false, "500", "ตัวชี้วัด ด้านพฤติกรรม ", true, true);

                            createChart("chart5", xVal_chart5, yVal_chart5, "bar", "x", false, "500", "", true, false);
                            createChart("chart6", xVal_chart6, yVal_chart6, "bar", "x", false, "500", "", true, false);

                            // createChart("chart2", "pie", "x", true, "500", "จำนวนผู้กรอกแบบสอบถาม จำแนกตามเพศ", 1);

                            function createChart(id, x, y, type, layout, legend, width, title, scaleX, percent) {

                                $("." + id).html('<canvas id="'+id+'" width="'+width+'" height="100"></canvas>')
                        
                                window[id] = document.getElementById(id);

                                window[id] = new Chart(window[id], {
                                    type: type,
                                    plugins: [ChartDataLabels],
                                    options: {
                                        // responsive: true,
                                        maintainAspectRatio: false,
                                        indexAxis: layout,
                                        animation: false,
                                        plugins: {
                                            title: {
                                                display: false,
                                                text: title,
                                                font: {
                                                    size: 24,
                                                    weight: "bold"
                                                },
                                                padding: {
                                                    // top: 10,
                                                    // bottom: 10,
                                                }
                                            },
                                            legend: {
                                                display: legend,
                                                position: "bottom",
                                                align: "center",
                                                title: {
                                                    display: true,
                                                    padding: 0,
                                                }
                                            }
                                        },
                                        scales: {
                                            x: {
                                                display: scaleX,
                                                min: 0,
                                                max: 100,
                                            }
                                        },
                                        layout: {
                                            padding: {
                                                top: 30,
                                                right: 60,
                                                bottom: 20,
                                                left: 60
                                            }
                                        },
                                    },
                                    data: {
                                        labels: x,
                                        datasets: [
                                            {
                                                label: 'Data',
                                                data: y,
                                                backgroundColor: bgColor,
                                                borderColor: bdColor,
                                                borderWidth: 2,
                                                barPercentage: 0.8,
                                                datalabels: {
                                                    clamp: true,
                                                    align: 'end',
                                                    anchor: 'end',
                                                    offset: 4,
                                                    font: {
                                                        weight: "bold",
                                                    },
                                                    formatter: function(value) {
                                                        if (value !== undefined) {
                                                            if (percent == true) {
                                                                return (value)+ '%';
                                                            } else {
                                                                return (value);
                                                            }
                                                        }
                                                    },
                                                    // color: bdColor
                                                }
                                                
                                            }
                                        ]
                                    }
                                });
                            }
                        $("#update").html("อัพเดทล่าสุด: " + (new Date()).toLocaleString());
                        $(".loading").hide();
                        $(".area").show();
                    });


            }


            $("#church").on("change", function() {
                startLiveUpdate();
            });

            document.addEventListener('DOMContentLoaded', function () {
                setInterval(function () {
                    startLiveUpdate();
                }, 2 * 1000);
            });

        </script>




</body>

</html>
